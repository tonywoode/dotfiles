# useful things I use that I don't want to forget

# if we're updating functions that already exist, they won't overwrite, they'll fail and you'll get left with the old fn. So first clear them
function unset_func_alias_if_exist() { #ignore this: utility fn
  type $1|grep function &>/dev/null && unset -f $1
  type $1|grep alias &>/dev/null && unalias $1
}

unset_func_alias_if_exist node_processes_no_vscode
function node_processes_no_vscode() {
  ps aux | grep node | grep -v "Visual Studio Code" | grep -v grep
}

unset_func_alias_if_exist gh-setup
function gh-setup() {
    if [[ $- == *i* ]]; then
        echo "ðŸ§¹ Cleaning up legacy GitHub CLI extensions..."
        # We check both names to be thorough, they retired these in favour of github cli
        gh extension remove copilot 2>/dev/null
        gh extension remove gh-copilot 2>/dev/null

        echo "ðŸ“¦ Checking standalone GitHub Copilot CLI..."
        if ! command -v copilot &> /dev/null; then
            echo "Installing GitHub Copilot CLI via npm..."
            npm install -g @github/copilot
        fi

        echo "ðŸ”‘ Ensuring authentication..."
        # Launching the agent once; follow the /login flow if prompted
        echo "If not logged in, type '/login' in the prompt, then Ctrl+C once done."
        copilot
        
        echo "âœ… Setup complete. 'ghcs' and 'ghce' are ready."
    fi
}

# remake these old and useful shell fns until such time github does (inspiration from https://github.com/github/copilot-cli/issues/53#issuecomment-3602525191, with help from https://gemini.google.com/app/52064e3915f63e47)
# GH Suggest (ghcs)
unset_func_alias_if_exist ghcs
function ghcs() {
  if [[ -z "$*" ]]; then echo "Usage: ghcs <prompt>"; return 1; fi

  # 1. Get raw output with stats disabled via --deny-tool
  local RAW=$(copilot --deny-tool 'shell(*)' -p "Output ONLY the shell command for: $*" 2>/dev/null)

  # 2. Extract content between triple backticks using AWK (more portable than sed)
  # This ignores the line with '```bash' and prints everything until the closing '```'
  local CMD=$(echo "$RAW" | awk '/^```/{f=!f;next} f')

  # 3. If the model didn't use backticks, fallback to the first line
  if [[ -z "$CMD" ]]; then
    CMD=$(echo "$RAW" | head -n 1)
  fi

  echo "$CMD"
}

# GH Explain (ghce)
unset_func_alias_if_exist ghce
function ghce() {
  if [[ -z "$*" ]]; then echo "Usage: ghce <command>"; return 1; fi

  # Explain doesn't need to strip backticks, just the usage stats
  copilot --deny-tool 'shell(*)' -p "Explain this shell command concisely: $*" 2>/dev/null
}

#This absurd "one-liner" will show you the name of the command running on each port on MacOS - https://x.com/seldo/status/1823126087423099192?s=48&t=2gkvF6feqpnKKTyk3DR7Wg
unset_func_alias_if_exist macos_active_ports
function macos_active_ports() {
  sudo lsof -iTCP -sTCP:LISTEN -n -P | awk 'NR>1 {print $9, $1, $2}' | sed 's/.*://' | while read port process pid; do echo "Port $port: $(ps -p $pid -o command= | sed 's/^-//') (PID: $pid)"; done | sort -n
}

# cleanai: Cleans and formats AI/Terminal text (primarly from tmux for TiddlyWiki for codex outputs) - copy text, run cleanai in any terminal, paste
# https://gemini.google.com/app/0d80d993097df8b6
# 1. Joins 80-char terminal hard-wraps into fluid paragraphs.
# 2. Restores 'we're' style contractions from terminal mojibake (â€šÃ„Ã´).
# 3. Strips non-ASCII junk and invisible Non-Breaking Spaces (\u00a0).
# 4. Forces paragraphs flush-left to prevent Wiki 'code block' formatting.
# 5. Preserves list indentation for lines starting with -, *, or â€¢.
# 6. Purges 'ghost spaces' from empty lines to ensure proper paragraph breaks.
unset_func_alias_if_exist cleanai
function cleanai() {
  pbpaste | \
  nvim -u NONE -es \
    -c "set nocompatible ff=unix | set formatoptions=tqnj | set textwidth=0" \
    -c "silent! %s/â€šÃ„Ã´/'/g | silent! %s/[^\x00-\x7F]/ /g" \
    -c "normal! ggVGgq" \
    -c "silent! %s/  \+/ /g" \
    -c "silent! %s/^\s\+\([-*â€¢]\)/  \1/g" \
    -c "silent! %s/^\s\+\([^-*â€¢]\)/\1/g" \
    -c "%p | qa!" /dev/stdin | \
  sed -E 's/^[[:space:]]+$//' | \
  pbcopy

  echo "âœ¨ text cleaned for pasting"
}

